name: AI Agent (Claude Code)

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to work on'
        required: true
        type: string
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ai-agent:
    # Trigger on any ai-* label
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' &&
       (contains(github.event.issue.labels.*.name, 'ai-feature') ||
        contains(github.event.issue.labels.*.name, 'ai-bug') ||
        contains(github.event.issue.labels.*.name, 'ai-refactor') ||
        contains(github.event.issue.labels.*.name, 'ai-docs') ||
        contains(github.event.issue.labels.*.name, 'ai-test')))

    runs-on: [self-hosted, macOS, quetrex]
    timeout-minutes: 120

    env:
      WORKTREE_BASE: /Users/barnent1/worktrees

    steps:
      - name: Get issue details
        id: issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}
          echo "number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # Get issue details
          ISSUE_JSON=$(gh issue view "$ISSUE_NUMBER" --repo ${{ github.repository }} --json title,body,labels)
          ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_JSON" | jq -r '.body')
          ISSUE_LABELS=$(echo "$ISSUE_JSON" | jq -r '.labels[].name' | tr '\n' ',' | sed 's/,$//')

          echo "title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "labels=$ISSUE_LABELS" >> $GITHUB_OUTPUT

          # Determine issue type from label
          if echo "$ISSUE_LABELS" | grep -q "ai-feature"; then
            echo "type=feature" >> $GITHUB_OUTPUT
            echo "prefix=feature" >> $GITHUB_OUTPUT
          elif echo "$ISSUE_LABELS" | grep -q "ai-bug"; then
            echo "type=bug" >> $GITHUB_OUTPUT
            echo "prefix=fix" >> $GITHUB_OUTPUT
          elif echo "$ISSUE_LABELS" | grep -q "ai-refactor"; then
            echo "type=refactor" >> $GITHUB_OUTPUT
            echo "prefix=refactor" >> $GITHUB_OUTPUT
          elif echo "$ISSUE_LABELS" | grep -q "ai-docs"; then
            echo "type=docs" >> $GITHUB_OUTPUT
            echo "prefix=docs" >> $GITHUB_OUTPUT
          elif echo "$ISSUE_LABELS" | grep -q "ai-test"; then
            echo "type=test" >> $GITHUB_OUTPUT
            echo "prefix=test" >> $GITHUB_OUTPUT
          else
            echo "type=feature" >> $GITHUB_OUTPUT
            echo "prefix=feature" >> $GITHUB_OUTPUT
          fi

          # Save body to file for multi-line handling
          echo "$ISSUE_BODY" > /tmp/issue_body.txt

      - name: Comment - Starting work
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} \
            --repo ${{ github.repository }} \
            --body "ü§ñ **AI Agent Starting**

          | Detail | Value |
          |--------|-------|
          | Type | \`${{ steps.issue.outputs.type }}\` |
          | Branch | \`${{ steps.issue.outputs.prefix }}/issue-${{ steps.issue.outputs.number }}\` |
          | Runner | \`quetrex-runner\` |
          | Run | [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

          Working on: **${{ steps.issue.outputs.title }}**"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup worktree
        id: worktree
        run: |
          ISSUE_NUMBER=${{ steps.issue.outputs.number }}
          BRANCH_NAME="${{ steps.issue.outputs.prefix }}/issue-${ISSUE_NUMBER}"
          WORKTREE_PATH="${WORKTREE_BASE}/${{ github.event.repository.name }}/issue-${ISSUE_NUMBER}"

          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "path=$WORKTREE_PATH" >> $GITHUB_OUTPUT

          # Create worktree directory
          mkdir -p "$WORKTREE_BASE/${{ github.event.repository.name }}"

          # Clean up existing worktree if present
          if [ -d "$WORKTREE_PATH" ]; then
            git worktree remove "$WORKTREE_PATH" --force 2>/dev/null || rm -rf "$WORKTREE_PATH"
          fi

          # Delete branch if exists (clean start)
          git branch -D "$BRANCH_NAME" 2>/dev/null || true
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

          # Create new branch and worktree
          git worktree add -b "$BRANCH_NAME" "$WORKTREE_PATH" origin/main

          echo "‚úÖ Worktree created at: $WORKTREE_PATH"

      - name: Setup dependencies
        run: |
          cd ${{ steps.worktree.outputs.path }}

          # Install dependencies if package.json exists
          if [ -f "package.json" ]; then
            npm install --legacy-peer-deps
            echo "‚úÖ Dependencies installed"
          else
            echo "‚ÑπÔ∏è No package.json found, skipping npm install"
          fi

      - name: Run Claude Code
        id: claude
        working-directory: ${{ steps.worktree.outputs.path }}
        run: |
          ISSUE_NUMBER=${{ steps.issue.outputs.number }}
          ISSUE_TITLE="${{ steps.issue.outputs.title }}"
          ISSUE_TYPE="${{ steps.issue.outputs.type }}"
          ISSUE_BODY=$(cat /tmp/issue_body.txt)

          # Configure git
          git config user.name "Quetrex AI Agent"
          git config user.email "agent@quetrex.dev"

          # Run Claude with the issue context
          claude -p "You are working on GitHub Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          Issue Type: ${ISSUE_TYPE}

          Description:
          ${ISSUE_BODY}

          Instructions:
          1. Read CLAUDE.md first if it exists for project conventions
          2. Implement the requested changes
          3. Test your changes if possible
          4. Commit your changes with conventional commit format
          5. Do NOT create a PR - just commit to this branch

          Branch: ${{ steps.worktree.outputs.branch }}

          When done, provide a summary of what you implemented." \
            --dangerously-skip-permissions \
            2>&1 | tee /tmp/claude_output.txt

          # Check if there are commits
          COMMIT_COUNT=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo "0")
          echo "commits=$COMMIT_COUNT" >> $GITHUB_OUTPUT

      - name: Push changes
        if: steps.claude.outputs.commits != '0'
        working-directory: ${{ steps.worktree.outputs.path }}
        run: |
          git push -u origin ${{ steps.worktree.outputs.branch }}
          echo "‚úÖ Changes pushed to ${{ steps.worktree.outputs.branch }}"

      - name: Comment - Work complete
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ steps.issue.outputs.number }}
          BRANCH_NAME="${{ steps.worktree.outputs.branch }}"
          WORKTREE_PATH="${{ steps.worktree.outputs.path }}"
          COMMIT_COUNT="${{ steps.claude.outputs.commits }}"

          if [ "${{ job.status }}" == "success" ] && [ "$COMMIT_COUNT" != "0" ]; then
            # Get commit summary
            cd "$WORKTREE_PATH" 2>/dev/null && \
            COMMITS=$(git log --oneline origin/main..HEAD 2>/dev/null | head -10) || \
            COMMITS="Unable to get commit list"

            gh issue comment "$ISSUE_NUMBER" \
              --repo ${{ github.repository }} \
              --body "‚úÖ **AI Agent Complete**

          ## Changes Made
          \`\`\`
          $COMMITS
          \`\`\`

          ## Next Steps
          1. **Test locally:**
             \`\`\`bash
             cd $WORKTREE_PATH
             npm run dev  # if applicable
             \`\`\`
          2. **When ready, tell me:** \`create PR for issue #${ISSUE_NUMBER}\`
          3. **After review:** \`merge PR\` or merge manually

          ---
          [View Branch](https://github.com/${{ github.repository }}/tree/${BRANCH_NAME}) | [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          elif [ "${{ job.status }}" == "success" ] && [ "$COMMIT_COUNT" == "0" ]; then
            gh issue comment "$ISSUE_NUMBER" \
              --repo ${{ github.repository }} \
              --body "‚ö†Ô∏è **AI Agent Complete - No Changes**

          The agent ran successfully but made no commits. This could mean:
          - The issue was already resolved
          - The agent couldn't determine what changes to make
          - The agent encountered an issue

          [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          else
            gh issue comment "$ISSUE_NUMBER" \
              --repo ${{ github.repository }} \
              --body "‚ùå **AI Agent Failed**

          The agent encountered an error. Please check the logs.

          [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          fi
